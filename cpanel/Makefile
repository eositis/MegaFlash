.PHONY: all release test clean 

#Source Files
DEPS       = Makefile defines.h asm.h ui-menu.h ui-textinput.h wifi.h timezone.h config.h testwifi.h format.h ../common/defines.h 
DEPSASM    = ../common/megaflash_defines.inc
SRC        = main.c mainmenu.c dialogs.c ui-menu.c ui-wnd.c ui-textinput.c ui-misc.c textstrings.c wifi.c timezone.c config.c testwifi.c format.c
ASM        = asm.s asm-megaflash.s asm-conio.s

#Depolyment Build
OUT        = cpanel.bin	
INTOUTDIR  = ./relbuild
INTR       = $(addprefix $(INTOUTDIR)/,$(SRC:.c=.s)) #.s files generated by compiler
OBJ        = $(INTR:.s=.o) $(addprefix $(INTOUTDIR)/,$(ASM:.s=.o))

#Test Build
OUTTEST    = cpanel.as
TESTOUTDIR = testbuild
TESTFLAG   = -D TESTBUILD=1
INTRTEST   = $(addprefix $(TESTOUTDIR)/,$(SRC:.c=.s)) #.s files generated by compiler
OBJTEST    = $(INTRTEST:.s=.o) $(addprefix $(TESTOUTDIR)/,$(ASM:.s=.o))


#Keep Intermediate .s file
.SECONDARY: $(INTR)	$(INTRTEST)

#Disable Implicit Rules
%.o:%.c	            

all: $(OUT) $(OUTTEST)

release: $(OUT)

test: $(OUTTEST)

#For importing to disk image and testing
$(OUTTEST):$(OBJTEST) $(DEPS) 
	ld65 -o $(OUTTEST) -t apple2enh -m $(TESTOUTDIR)/$(OUTTEST:.as=.map) $(OBJTEST) apple2enh.lib 
	java -jar ./acx18.jar import  --as -d prodos19.dsk -a=0x803  -f $(OUTTEST)	

#For release
$(OUT):$(OBJ) $(DEPS)   
	ld65 -o $(OUT) -C apple2enh-bin.cfg -m $(INTOUTDIR)/$(OUT:.bin=.map) $(OBJ) apple2enh.lib 

########## Release ##########
#.s files generated by compiler
$(INTOUTDIR)/%.o:$(INTOUTDIR)/%.s $(DEPS) 
	ca65 -t apple2enh $(INTOUTDIR)/$*.s -o $(INTOUTDIR)/$*.o -l $(INTOUTDIR)/$*.lst

#.c files
$(INTOUTDIR)/%.s:%.c $(DEPS) | $(INTOUTDIR)
	cc65 -O  -t apple2enh $*.c -o $(INTOUTDIR)/$*.s

#.asm files
$(INTOUTDIR)/%.o:%.s $(DEPSASM) 
	ca65 -t apple2enh $*.s -o $(INTOUTDIR)/$*.o -l $(INTOUTDIR)/$*.lst
	
$(INTOUTDIR):
	mkdir -p $(INTOUTDIR)	
	
########## Test Build ##########
#.s files generated by compiler
$(TESTOUTDIR)/%.o:$(TESTOUTDIR)/%.s $(DEPS) 
	ca65 -t apple2enh $(TESTFLAG) $(TESTOUTDIR)/$*.s -o $(TESTOUTDIR)/$*.o -l $(TESTOUTDIR)/$*.lst

#.c files
$(TESTOUTDIR)/%.s:%.c $(DEPS) | $(TESTOUTDIR)
	cc65 -O  -t apple2enh $(TESTFLAG) $*.c -o $(TESTOUTDIR)/$*.s

#.asm files
$(TESTOUTDIR)/%.o:%.s $(DEPSASM) 
	ca65 -t apple2enh $(TESTFLAG) $*.s -o $(TESTOUTDIR)/$*.o -l $(TESTOUTDIR)/$*.lst

$(TESTOUTDIR):
	mkdir -p $(TESTOUTDIR)	


clean:
	rm -f $(OUT) $(OUTTEST)
	rm -f $(INTR)
	rm -f $(INTRTEST)
	rm -f $(OBJ)
	rm -f $(OBJTEST)
	rm -f $(INTOUTDIR)/*.lst  $(INTOUTDIR)/*.map
	rm -f $(TESTOUTDIR)/*.lst $(TESTOUTDIR)/*.map
	